FROM docker.io/ubuntu:24.04 AS env
RUN apt-get update && \
    apt-get install -y build-essential curl git ninja-build \
        autoconf automake autotools-dev libmpc-dev libmpfr-dev libgmp-dev \
        gawk build-essential bison flex texinfo gperf libtool patchutils \
        bc zlib1g-dev libexpat-dev cmake libglib2.0-dev libslirp-dev \
        python3-pip python3-venv python3-sphinx-rtd-theme && \
    apt-get clean

FROM env AS toolchain
COPY gitconfig /root/.gitconfig
RUN git clone --recursive --shallow-submodules \
   https://github.com/riscv/riscv-gnu-toolchain
RUN apt-get update && \ 
    apt-get install -y libcrypt-dev && \ 
    apt-get clean
ENV LDFLAGS="-L/usr/lib -lcrypt"
ENV CPPFLAGS="-I/usr/include"
WORKDIR /riscv-gnu-toolchain
RUN ./configure --prefix=/opt/riscv --with-arch=rv64g --with-abi=lp64d --enable-libsanitizer && \
   make -j2 linux

FROM env AS qemu
RUN curl -O https://download.qemu.org/qemu-9.0.0.tar.xz && \
    tar -xf qemu-9.0.0.tar.xz
WORKDIR /qemu-9.0.0
RUN ./configure --target-list=riscv64-linux-user && make -j

FROM docker.io/ubuntu:24.04
RUN apt-get update && \
    apt-get install -y python3-dev libmpc-dev libglib2.0 git \
        device-tree-compiler && \
    apt-get clean

# Add the various tools.
COPY --from=qemu /qemu-9.0.0/build/qemu-riscv64 /usr/local/bin/
COPY --from=toolchain /opt/riscv /opt/riscv

# Create unprefixed symlinks to the GNU tools.
COPY mklinks.sh /
RUN bash /mklinks.sh

# Some useful configuration for Qemu.
ENV QEMU_LD_PREFIX=/opt/riscv/sysroot
ENV QEMU_GUEST_BASE=0x14000

env PATH $PATH:/opt/riscv/bin
WORKDIR /root
